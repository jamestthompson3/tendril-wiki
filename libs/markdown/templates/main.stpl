<!DOCTYPE html>
<html lang="en-US" prefix="og:http://ogp.me/ns#">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <% include!("styles.stpl"); %>
    <meta name="description" content="An HTML File" />
    <meta property="og:title" content="<%= title %>" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />
    <title><%= title %></title>
  </head>
  <body>
    <% include!("nav.stpl"); %>
    <div class="content-container">
        <label for="edit">Edit:</label>
        <input type="checkbox" id="edit" />
        <form action="delete" method="post" target="_parent" onsubmit="return confirm('Do you really want to delete <%- title %>?');">
          <input class="hidden" type="text" name="title" value="<%- title %>" />
          <button class="danger" type="submit">Delete</button>
        </form>
      <form class="editor" method="post" action="/edit" target="_parent">
      <input class="hidden" type="text" name="old_title" value="<%- title %>" />
      <button type="submit" class="submit">Save</button>
        <label for="title-edit">Title</label>
        <input name="title" id="title-edit" type="text" value="<%- title %>" />
        <label for="tag-edit">Tags</label>
        <input id="tag-edit" type="text" name="tags" value="<%- tags.join(",") %>" />
        <label for="body">Body</label>
        <textarea id="body" name="body"><%- raw_md %></textarea>
        <label for="metadata">Metadata</label>
        <textarea id="metadata" name="metadata" style="height: 150px;"><%- metadata.iter().map(|(k, v)| format!("{}:{}", k, v) ).collect::<Vec<String>>().join("\n") %></textarea>
      </form>

      <div class="content">
        <h1 class="title"><%= title %></h1>
        <div>
          <ul class="tags">
            <% for tag in tags.iter() {  %>
            <li><a href="/tags/<%- tag %>">#<%- tag %></a></li>
            <% } %>
          </ul>
        </div>
        <main class="content-body">
          <%- body %>
        </main>
        <details class="metadata">
          <summary>Metadata</summary>
          <div>
            <dl>
              <% for (key, value) in metadata.iter() { %>
              <dt><strong><%= key %>:</strong></dt>
              <%
              let mut val = String::new();
              // TODO: Add "created" date here as well
              // TODO: Modify dates to be compliant with DT parsing
              // if key == "modified" {
              //     val = value.parse::<DateTime<FixedOffset>>().unwrap().format("%Y-%m-%d %H:%M").to_string();
              //   }
              if value.starts_with("http") {
                match key.as_str() {
                  "cover" => {
                    val = format!("<img src=\"{}\" style=\"max-height: 200px; max-width: 200px;\">", value);
                  }
                  _ => {
                    val = format!("<a href=\"{}\">{}</a>", value, value);
                  }
                }
              }
              else {
                val = value.into();
              }
            %>
            <dd><%- val %></dd>
            <% } %>
            </dl>
          </div>
        </details>
        <% if !backlinks.is_empty() { %>
        <section class="backlinks-container">
          <hr />
          <h3>Mentioned in:</h3>
          <div class="backlinks">
            <% use super::html::format_links;  %>
            <% for link in backlinks.iter() {  %>
            <a href="<%- format_links(&link) %>"><%- link %></a>
            <% } %>
          </div>
        </section>
        <% } %>
      </div>
    </div>
    <% include!("footer.stpl"); %>
  </body>
</html>
